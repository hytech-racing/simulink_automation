name: run gen code on matlab runner on dispatch from simulink repo
on:
  workflow_dispatch:  # Listen for manual or external triggers

env:
  MLM_LICENSE_TOKEN: ${{ secrets.MLM_LICENSE_TOKEN }} # Defined as a secret in GitHub config

jobs:
  create-artifact:
    name: Generate source code from simulink models and create artifact
    runs-on: ubuntu-latest
    steps:
      - name: Set up MATLAB
        uses: matlab-actions/setup-matlab@v2
        with:
          release: R2024b
          cache: true
          products: |
            Simulink
            Signal_Processing_Toolbox
            Simulink_Coder
            Embedded_Coder
            Phased_Array_System_Toolbox
            Control_System_Toolbox

      - name: Run script
        uses: matlab-actions/run-command@v2
        with:
          command: addpath("Controllers", "Lateral Models", "Pacejka52", "Vehicle Math"), gen_code
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      
      - name: Checkout the HyTech_sim repo
        uses: actions/checkout@v4
        with:
          repository: hytech-racing/HyTech_sim
          token: ${{ secrets.BENS_PAT }}
          path: HyTech_sim
          ref: 'main'

      - name: remove old CASE_lib files and Copy new files to CASE_lib repository
        run: |
          mkdir source_models
          cp -r HyTech_sim/Vehicle Models/HT09 Vehicle Model/* source_models/
      
      - name: Run Python script
        run: |
          mkdir source_code
          python process_simulink_codegen.py source_code
        
      - name: Upload artifacts
        uses: actions/upload-artifact@master
        with: 
          name: dist
          path: source_code/
